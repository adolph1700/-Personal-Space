' VBA script to test for key prerequisites for modern authentication flows.
' It checks for general internet access, connectivity to Azure AD,
' and the ability to perform a localhost redirect.

' --- Main Subroutine to run all tests ---
Public Sub RunAllPrerequisiteTests()
    Dim results As String
    
    ' Initialize results string with a header
    results = "Prerequisite Test Results:" & vbCrLf & "--------------------------------" & vbCrLf & vbCrLf
    
    ' Run each test and append the result to the string
    results = results & "Test 1: General Internet Access" & vbCrLf & TestOutboundConnection() & vbCrLf & vbCrLf
    results = results & "Test 2: Azure AD Authentication Endpoint" & vbCrLf & TestAzureADConnection() & vbCrLf & vbCrLf
    results = results & "Test 3: Localhost Redirect Capability" & vbCrLf & TestLocalhostNavigation() & vbCrLf & vbCrLf
    
    results = results & "--------------------------------" & vbCrLf & "See comments in the code for details on what each test means."

    ' Display the final results in a message box
    MsgBox results, vbInformation, "Prerequisite Check Complete"
End Sub


' --- TEST 1: Checks for basic outbound internet connectivity ---
Private Function TestOutboundConnection() As String
    On Error GoTo ConnectionError ' Error handling
    
    Dim http As Object
    Set http = CreateObject("MSXML2.XMLHTTP.6.0")
    
    ' Attempt to connect to a highly available, benign website.
    http.Open "GET", "https://www.microsoft.com", False
    http.send
    
    ' A status of 200 means the request was successful.
    If http.Status = 200 Then
        TestOutboundConnection = "  [SUCCESS] - Connection to the public internet is allowed."
    Else
        TestOutboundConnection = "  [FAILURE] - Connected, but received an unexpected status: " & http.Status & " " & http.statusText
    End If
    
    Set http = Nothing
    Exit Function

ConnectionError:
    TestOutboundConnection = "  [FAILURE] - Could not connect to the internet. A firewall or proxy may be blocking outbound VBA requests. Error: " & Err.Description
    Set http = Nothing
End Function


' --- TEST 2: Checks for specific connectivity to the Microsoft login service ---
Private Function TestAzureADConnection() As String
    On Error GoTo ConnectionError
    
    Dim http As Object
    Set http = CreateObject("MSXML2.XMLHTTP.6.0")
    
    ' This URL is the root of the Azure AD authentication service.
    http.Open "GET", "https://login.microsoftonline.com", False
    http.send
    
    ' Any successful connection (even a redirect, like status 302) is a success here.
    If http.Status >= 200 And http.Status < 400 Then
         TestAzureADConnection = "  [SUCCESS] - Connection to the Azure AD login service is allowed."
    Else
        TestAzureADConnection = "  [FAILURE] - Connected, but received an error status: " & http.Status & " " & http.statusText
    End If

    Set http = Nothing
    Exit Function

ConnectionError:
    TestAzureADConnection = "  [FAILURE] - Could not connect to Azure AD. The firewall is likely blocking this specific endpoint. Error: " & Err.Description
    Set http = Nothing
End Function


' --- TEST 3: Checks if VBA can launch a browser and navigate to a localhost address ---
Private Function TestLocalhostNavigation() As String
    On Error GoTo NavigationError
    
    Dim ie As Object
    Set ie = CreateObject("InternetExplorer.Application")
    
    ' Attempt to navigate to a common localhost address used for redirects.
    ie.Navigate "http://localhost:8080/callback"
    
    ' Wait for the browser to become idle.
    Do While ie.Busy
        DoEvents
    Loop
    
    ' SUCCESS: If we reach this point without an error, it means security
    ' software did not block the attempt to control the browser and navigate locally.
    ' A "Page cannot be displayed" error in the browser itself is expected and is a SUCCESS.
    TestLocalhostNavigation = "  [SUCCESS] - Browser automation to a localhost address was not blocked."
    
    ie.Quit
    Set ie = Nothing
    Exit Function

NavigationError:
    ' FAILURE: An error here usually means that endpoint security software
    ' or a group policy is preventing scripts from automating the browser.
    TestLocalhostNavigation = "  [FAILURE] - Could not navigate to localhost. Endpoint security may be blocking browser automation. Error: " & Err.Description
    Set ie = Nothing
End Function
